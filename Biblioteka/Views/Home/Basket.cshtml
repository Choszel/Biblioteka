@{
    Layout = "_Layout";
    ViewData["Title"] = "Koszyk";
}

<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
    }

    table {
        padding-top: 50px;
        border-collapse: collapse;
    }

    thead {
        color: gray;
        font-weight: bold;
        padding: 5px;
        border-bottom: 1px black solid;
    }

    tr, td, th {
        padding: 5px;
        padding-top: 15px;
        padding-bottom: 15px;
        text-align: center;
    }

    th {
        font-weight: normal;
    }

    caption {
        margin-top: 30px;
        margin-bottom: 50px;
        border-top: thin black solid;
        border-bottom: thin black solid;
        font-weight: bold;
        padding: 5px;
        font-size: 30px;
        color: dimgray;
        font-weight: normal;
    }

    tfoot {
        border-top: 1.5px black solid;
    }
</style>


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <div id="out">
    </div>
    <br>
    <br>
    <br>
    <button id="but2" style="margin-left: 20 px;" onclick="clearAll()">Opróżnij koszyk</button>

    <dialog id="dialog2">
        <h4>
            Czy na pewno chcesz usunąć wszystkie produkty?</h2>
            <form id="form2" method="dialog">
                <input type="submit" value="Usuń">
                <input type="reset" value="Anuluj">
            </form>
    </dialog>

    <dialog id="dialog4">
        <h2>
            Usuń produkt</h4>
            <hr>
            <p>Czy napewno chcesz usunąć ten produkt z koszyka?</p>
            <form id="form4">
                <input type="submit" value="Usuń">
                <input type="reset" value="Anuluj">
            </form>
    </dialog>
    <p id="low"></p>
</body>
</html>

<script>

    var bookList = @Html.Raw(Json.Serialize(ViewData["bookList"]));

    const out = document.getElementById("out");

    const table = document.createElement("TABLE");

    let index = localStorage.length - 1;
    let modif;
    if (JSON.parse(localStorage.getItem(-1)) != null) {
        const indexnegative = JSON.parse(localStorage.getItem(-1));
        modif = indexnegative.modif;
    }
    else {
        modif = 0;
        localStorage.setItem((-1).toString(),
            JSON.stringify(
                {
                    modif: modif
                }));
    }
    let x = 0;

    table.appendChild(addCaption());
    table.appendChild(addHeader());
    table.appendChild(addBody());
    table.appendChild(addFooter());

    colorRow();

    out.appendChild(table);

    const lowermessage = document.getElementById("low");

    const btn2 = document.getElementById("but2");
    const form2 = document.getElementById("form2");
    const dlg2 = document.getElementById("dialog2");

    const form3 = document.getElementById("form3");
    const dlg3 = document.getElementById("dialog3");

    const form4 = document.getElementById("form4");
    const dlg4 = document.getElementById("dialog4");

    btn2.onclick = () => {
        form2.reset();
        dlg2.showModal();
    }

    form2.onsubmit = () => {
        modif = 0;
        localStorage.clear();
        localStorage.setItem((-1).toString(),
            JSON.stringify(
                {
                    modif: modif
                }));
        location.reload();
    }

    form2.onreset = () => {
        dlg2.close();
    }

    form4.onsubmit = () => {
        removeProduct();

        modif++;
        localStorage.setItem((-1).toString(),
            JSON.stringify(
                {
                    modif: modif
                }));
    }

    form4.onreset = () => {
        dlg4.close();
    }

    function removeProduct() {
        var storedBooks = localStorage.getItem("books");
        var books = {};

        if (storedBooks) books = JSON.parse(storedBooks);
     
        delete books[x];

        localStorage.setItem("books", JSON.stringify(books));   
        location.reload();
    }

    function addCaption() {
        const caption = document.createElement("CAPTION");
        let today = new Date();
        caption.innerHTML = "KOSZYK " + today.getDate() + "-" + (today.getMonth() + 1) + "-" + (today.getFullYear() % 100) + "/" + String(modif).padStart(3, '0');
        return caption;
    }

    function addHeader() {
        const thead = document.createElement("THEAD");
        const headerRow = thead.insertRow();
        const headers = ["LP", "NAZWA", "ILOŚĆ", "CENA", "SUMA"];

        for (let i = 0; i < headers.length; ++i) {
            let th = document.createElement("TH");
            if (i == 1) {
                th.style.textAlign = "left";
            }
            if (i == 2) {
                th.style.textAlign = "right";
            }
            th.style.width = "100px";
            th.innerHTML = headers[i];
            headerRow.appendChild(th);
        }

        return thead;
    }

    function addBody() {
        const tbody = document.createElement("TBODY");

        var storedBooks = localStorage.getItem("books");

        if (storedBooks) {
            var books = JSON.parse(storedBooks);

            for (var bookId in books) {
                if (books.hasOwnProperty(bookId)) {
                    let obj = new Object();
                    for (const element of bookList) {
                        if (element.bookId == bookId) {
                            obj = element;
                            break;
                        }
                        else;
                    }

                    var quantity = books[bookId];

                    const headerRow = tbody.insertRow();
                    let td = document.createElement("TD");
                    let img = document.createElement("img");
                    img.src = obj.bookPhoto;
                    td.appendChild(img);
                    headerRow.appendChild(td);

                    td = document.createElement("TD");
                    td.style.textAlign = "left";
                    td.innerHTML = obj.title;                   
                    headerRow.appendChild(td);
                    
                    td = document.createElement("TD"); //ilość
                    td.style.textAlign = "right";

                    const div =  document.createElement("div");
                    const but4 = document.createElement("BUTTON");
                    but4.innerHTML = "+";
                    but4.id = "ba" + bookId; //ButtonAdd
                    but4.onclick = function () {
                        x = obj.bookId;
                        var storedBooks = localStorage.getItem("books");
                        var books = {};

                        if (storedBooks) books = JSON.parse(storedBooks);
                        books[obj.bookId] = books[obj.bookId] + 1;                      
                        localStorage.setItem("books", JSON.stringify(books));

                        let modif = (localStorage.getItem(-1).modif) + 1;
                        localStorage.setItem((-1).toString(),
                            JSON.stringify(
                                {
                                    modif: modif
                                }));
                        location.reload();
                    };                 

                    const but3 = document.createElement("BUTTON");
                    but3.innerHTML = "-";
                    but3.id = "bd" + bookId;
                    but3.onclick = function () {
                        x = obj.bookId;
                        var storedBooks = localStorage.getItem("books");
                        var books = {};

                        if (storedBooks) books = JSON.parse(storedBooks);
                        if (books[obj.bookId] == 1) {
                            form4.reset();
                            dlg4.showModal();
                        }
                        else {
                            books[obj.bookId] = books[obj.bookId] - 1;
                            localStorage.setItem("books", JSON.stringify(books));
                        

                            let modif = (localStorage.getItem(-1).modif) + 1;
                            localStorage.setItem((-1).toString(),
                                JSON.stringify(
                                    {
                                        modif: modif
                                    }));
                            location.reload();
                            }                        
                    };
                    but3.style = but4.style = "margin-top: 15px; margin-left: 5px; margin-right: 5px;";

                    div.innerHTML += quantity;
                    div.appendChild(but3);                   
                    div.appendChild(but4);                   

                    td.appendChild(div);
                    headerRow.appendChild(td);

                    td = document.createElement("TD");
                    td.innerHTML = (parseFloat(obj.price)).toFixed(2) + " zł";
                    headerRow.appendChild(td);

                    td = document.createElement("TD");
                    td.innerHTML = (Math.round(obj.price * quantity * 100) / 100).toFixed(2) + " zł";
                    headerRow.appendChild(td);                    
                }
            }
        }     
        return tbody;
    }

    function addFooter() {
        const tfoot = document.createElement("TFOOT");
        const footerRow = tfoot.insertRow();
        let remainingCell = document.createElement("TH");
        remainingCell.colSpan = 3;
        footerRow.appendChild(remainingCell);

        for (let i = 0; i < 2; ++i) {
            let th = document.createElement("TH");
            if (i == 0) th.innerHTML = "RAZEM";
            else {
                let sum = 0;
                for (let j = 1; j < table.rows.length; j++) {
                    sum += parseFloat(table.rows[j].cells[4].innerHTML);
                }
                th.innerHTML = sum.toFixed(2) + " zł";
            }
            footerRow.appendChild(th);
        }

        return tfoot;
    }

    function colorRow() {
        for (let i = 0; i < table.rows.length; i++) {
            if (i % 2 != 0) table.rows[i].style = "background-color:whitesmoke;";
        }
    }
</script>